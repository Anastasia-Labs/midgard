\documentclass[../midgard.tex]{subfiles}
\graphicspath{{\subfix{../images/}}}
\usepackage{amsmath}
\begin{document}

\section{Midgard Ledger Rules and Fraud Proofs}
\label{h:ledger-rules-fraud-proofs}

In the following sections the following premises are used:

\begin{equation*}
\begin{split}
           b & \in Blocks          \\
         txs & := transactions(b)  \\
 utxos_{pre} & := prev\_utxos(b)   \\
utxos_{post} & := utxos(b)         \\
        wtxs & := withdrawals(b)
\end{split}
\end{equation*}

\subsection{Rule: All inputs must be valid}
\label{rule:all-inputs-must-be-valid}

A transaction cannot spend a non-existing (or an already spent) UTxO. Formal specification:
\begin{equation*}
\begin{split}
    \forall t \in Ledger, &\forall i \in spend\_inputs(t): \\
    &( \exists t_1 \in Ledger, t \neq t_1 \land i \in outputs(t_1) ) \land \\
    &( \nexists t_2 \in Ledger, t \neq t_2 \land i \in spend\_inputs(t_2) )
\end{split}
\end{equation*}

This ledger rule is violated if any of the following violations occur:
\begin{itemize-multi}
  \item \hyperref[violation:NO-INPUT]{NO-INPUT}
  \item \hyperref[violation:INPUT-NO-IDX]{INPUT-NO-IDX}
  \item \hyperref[violation:WITHDRAWN-INPUT]{WITHDRAWN-INPUT}
  \item \hyperref[violation:DOUBLE-SPEND]{DOUBLE-SPEND}
  \item \hyperref[violation:DOUBLE-WITHDRAW]{DOUBLE-WITHDRAW}
\end{itemize-multi}

\subsubsection{NO-INPUT violation}
\label{violation:NO-INPUT}
A transaction $t$ attempted to spend the UTxO $i$ that does not exist or was spent in a previous block.
Formal specification:
\begin{equation*}
\begin{split}
    \exists t \in txs, &\exists i \in spend\_inputs(t): \\
    &( i \notin utxos_{prev} ) \land  \\
    &( \nexists t_1 \in txs, t \neq t_1 \land tx\_hash(t_1) = tx\_hash(i) )
\end{split}
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule. 
  \item A membership proof must be provided for $t$ that shows that the transaction is included in the block ($t \in txs$).
  \item A membership proof for input $i$ must be specified such that $i \in spend\_inputs(t)$.
  \item A non-membership proof must be created to show that $i$ is not in $utxos_{prev}$.
  \item A non-membership proof must also be generated that shows that there are no transactions in $txs$ that have id $tx\_hash(i)$.
\end{enumerate}

\subsubsection{INPUT-NO-IDX violation}
\label{violation:INPUT-NO-IDX}
A transaction $t$ attempted to spend the input $i$, which did not exist at all.
Formal specification:
\begin{equation*}
\begin{split}
    \exists t \in txs, &\exists i \in spend\_inputs(t): \\
    &( \exists t_1 \in txs, tx\_hash(t_1) = tx\_hash(i) \land i \notin outputs(t_1) )
\end{split}
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule. 
  \item A membership proof must be provided for $t$ that shows that the transaction is included in the block ($t \in txs$)
  \item A membership proof must be presented for input $i$ such that $i \in spend\_inputs(t)$
  \item A membership proof must be created for $t_1$ such that $tx\_hash(t_1) = tx\_hash(i)$
  \item A DA layer proof must be presented that certifies that $length(outputs(t_1)) < index(i)$
\end{enumerate}

\subsubsection{WITHDRAWN-INPUT violation}
\label{violation:WITHDRAWN-INPUT}
A transaction $t$ attempted to spend the input $i$, which was spent in a withdraw transaction.
Formal specification:
\begin{equation*}
    \exists t \in txs, \exists i \in spend\_inputs(t), \exists w \in wtxs, i = l2\_outref(wtx)
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule. 
  \item A membership proof must be provided for $t$ that shows that the transaction is included in the block ($t \in txs$)
  \item A membership proof must be generated for input $i$ such that $i \in spend\_inputs(t)$
  \item A membership proof must be created to show that $w$ is in $wtxs$, which also spends input $i$
\end{enumerate}

\subsubsection{DOUBLE-SPEND violation}
\label{violation:DOUBLE-SPEND}
A transaction $t$ attempted to spend the input $i$, which was spent in another transaction.
Formal specification:
\begin{equation*}
    \exists t \in txs, \exists i \in spend\_inputs(t), \exists t_1 \in tx, t \neq t_1 \land i \in spend\_inputs(t_1)
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule. 
  \item A membership proof must be provided for $t$ that shows that the transaction is included in the block ($t \in txs$)
  \item A membership proof must be generated for input $i$ such that $i \in spend\_inputs(t)$
  \item A membership proof must be created to show that $t_1$ is in $txs$
  \item A membership proof must be given that verifies that $i \in spend\_inputs(t_1)$
\end{enumerate}

\subsubsection{DOUBLE-WITHDRAW violation}
\label{violation:DOUBLE-WITHDRAW}
A withdrawal $w$ attempted to spend the same input, which was already withdrawn by $w_1$.
Formal specification:
\begin{equation*}
    \exists w, w_1 \in wtxs, w \neq w_1 \land l2\_outref(w) = l2\_outref(w_1)
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule. 
  \item A membership proof must be provided for $w$ that shows that the withdraw transaction is included in the block ($w \in wtxs$)
  \item A membership proof must be created to show that $w_1$ is in $wtxs$
\end{enumerate}

\subsection{Rule: Transaction validity range}
\label{rule:transaction-validity-range}
Every valid transaction in the ledger must be included at a timestamp that conforms to the validity range that the transaction prescribes.
Formal specification:
\begin{equation*}
\begin{split}
    \forall t \in Ledger, time\_range(block(t)) \subseteq validity\_interval(t)
\end{split}
\end{equation*}

This ledger rule is violated if any of the following violations occur:
\begin{itemize-multi}
  \item \hyperref[violation:INVALID-RANGE]{INVALID-RANGE}
\end{itemize-multi}

\subsubsection{INVALID-RANGE violation}
\label{violation:INVALID-RANGE}
A transaction $t$ has a time-validity range that does not overlap with its block's event interval. 
Formal specification:
\begin{equation*}
    \exists t \in txs, time\_range(b) \nsubseteq validity\_interval(t)
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule. 
  \item A membership proof must be provided that proves that transaction $t$ is included in the block $b$
\end{enumerate}

\subsection{Rule: At least one input}
\label{rule:at-least-one-input}
Every valid transaction in the ledger must spend at least one UTxO.
Formal specification:
\begin{equation*}
    \forall t \in Ledger, |spend\_inputs(t)| > 0
\end{equation*}

This ledger rule is violated if any of the following violations occur:
\begin{itemize-multi}
  \item \hyperref[violation:ZERO-INPUT]{ZERO-INPUT}
\end{itemize-multi}

\subsubsection{ZERO-INPUT violation}
\label{violation:ZERO-INPUT}
A transaction $t$ is in the ledger, while $|inputs(t)| = 0$
Formal specification:
\begin{equation*}
    \exists t \in txs, |spend\_inputs(t)| = 0
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule. 
  \item A membership proof must be provided that shows that the transaction is included in the ledger
  \item A DA layer proof must be presented that certifies that $length(spend\_inputs(t)) = 0$
\end{enumerate}

\subsection{Rule: Minimum fee}
\label{rule:minimum-fee}
Every valid transaction in the ledger must pay the fees for inclusion.
Formal specification:
\begin{equation*}
    \forall t \in Ledger, tx\_fee(t) \geq min\_fee(t)
\end{equation*}

The fee calculation algorithm is the same as in Cardano ... \todo

This ledger rule is violated if any of the following violations occur:
\begin{itemize-multi}
  \item \hyperref[violation:MIN-FEE]{MIN-FEE}
\end{itemize-multi} 

\subsubsection{MIN-FEE violation}
\label{violation:MIN-FEE}
A transaction $t$ is in the ledger, while $fee(t) < min\_fee(t)$.
Formal specification:
\begin{equation*}
    \exists t \in txs, fee(t) < min\_fee(t)
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule. 
  \item A membership proof must be provided that shows that the transaction is included in the ledger
\end{enumerate}

\subsection{Rule: Required signatures are correct}
\label{rule:required-signatures-are-correct}
Every valid transaction in the ledger must correctly show the required signers.
Formal specification:
\begin{equation*}
\begin{split}
    \forall t & \in Ledger, required\_signer\_hashes(t) = \\
    & \{ \, paymentHK(addr(u)) \, | \, (r, u) \in utxos_{post}, r \in spend\_inputs(t), addr(u) \in Addr^{vkey} \, \}
\end{split}
\end{equation*}
    
This ledger rule is violated if any of the following violations occur:
\begin{itemize-multi}
  \item \hyperref[violation:MISSING-REQ-SIGNER]{MISSING-REQ-SIGNER}
  \item \hyperref[violation:NON-REQ-SIGNER]{NON-REQ-SIGNER}
\end{itemize-multi}

\subsubsection{MISSING-REQ-SIGNER violation}
\label{violation:MISSING-REQ-SIGNER}
A transaction $t$ is in the ledger and it violates the "Required signatures" property.
Formal specification:
\begin{equation*}
\begin{split}
    \exists t & \in txs, \exists r \in spend\_inputs(t), \exists u \in output(t), \\
    & (r, u) \in utxos_{post} \land paymentHK(addr(u)) \notin required\_signer\_hashes(t) \, \land \\
    & addr(u) \in Addr^{vkey}
\end{split}
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule. 
  \item A membership proof must be provided that shows that the transaction is included in the ledger
  \item A DA layer proof must be presented that shows that $r \in spend\_inputs(t)$
  \item A membership proof must be generated that shows that $(r, u) \in utxos_{post}$
  \item A DA layer proof must be shown that proves that \\ $paymentHK(addr(u)) \notin required\_signer\_hashes(t)$
\end{enumerate}

\subsubsection{NON-REQ-SIGNER violation}
\label{violation:NON-REQ-SIGNER}
A transaction $t$ is in the ledger and it violates the "Required signatures" property.
Formal specification:
\begin{equation*}
\begin{split}
    \exists t & \in txs, \exists vkey \in required\_signer\_hashes(t), \nexists (r, u) \in utxos_{post}, \\
    & r \in spend\_inputs(t) \land paymentHK(addr(u)) = vkey \land addr(u) \in Addr^{vkey}
\end{split}
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule. 
  \item A membership proof must be provided that shows that the transaction $t$ is included in the ledger
  \item A DA layer proof must be presented that shows that for a specified $vkey$ there is no utxo $u \in utxos_{post}$, such that the address of $u$ corresponds to $vkey$ and $t$ spends $u$
\end{enumerate}

\subsection{Rule: Signatures are valid}
\label{rule:signatures-are-valid}
Every provided signature must be valid.
Formal specification:
\begin{equation*}
    \forall t \in Ledger, \forall (v, s, h) \in addr\_tx\_wits(t), is\_valid\_signature(v, s, h)
\end{equation*}
        
This ledger rule is violated if any of the following violations occur:
\begin{itemize-multi}
  \item \hyperref[violation:INVALID-SIGNATURE]{INVALID-SIGNATURE}
\end{itemize-multi}

\subsubsection{INVALID-SIGNATURE violation}
\label{violation:INVALID-SIGNATURE}
There exists an invalid signature for transaction $t$ (if indeed the signature $(v, s, h)$ is not valid).
Formal specification:
\begin{equation*}
    \exists t \in txs, \exists (v, s, h) \in addr\_tx\_wits(t), \lnot is\_valid\_signature(v, s, h)
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule. 
  \item A membership proof must be provided that shows that the transaction $t$ is included in the ledger
  \item A membership proof must be shown that states that $(v, s, h) \in addr\_tx\_wits(t)$
\end{enumerate}

\subsection{Rule: Every needed signature is provided}
\label{rule:every-needed-signature-is-provided}
Every required signature is provided.
Formal specification:
\begin{equation*}
    \forall t \in Ledger, \forall h \in required\_signer\_hashes(t), \exists (v, s, h) \in addr\_tx\_wits(t)
\end{equation*}
        
This ledger rule is violated if any of the following violations occur:
\begin{itemize-multi}
  \item \hyperref[violation:MISSING-SIGNATURE]{MISSING-SIGNATURE}
\end{itemize-multi}

\subsubsection{MISSING-SIGNATURE violation}
\label{violation:MISSING-SIGNATURE}
A required signature, corresponding to $h$ is missing.
Formal specification:
\begin{equation*}
    \exists t \in txs, \exists h \in required\_signer\_hashes(t), h \notin \{ h_p \, | \, (v, s, h_p) \in addr\_tx\_wits(t) \}
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule. 
  \item A membership proof must be provided that shows that the transaction $t$ is included in the ledger
  \item A DA layer proof must be shown that states that $h \in required\_signer\_hashes(t)$
  \item A DA layer proof must be presented that shows that a signature with $h$ does not exist
\end{enumerate}

\subsection{Rule: Multisig scripts are available}
\label{rule:multisig-scripts-are-available}
All multisig scripts are provided.
Formal specification:
\begin{equation*}
\begin{split}
  \forall t \in txs, & \forall u \in output(t), addr(u) \in Addr^{script} \rightarrow \\
  & \exists (h, s) \in script\_tx\_wits(t), script\_hash(addr(u)) = h
\end{split}
\end{equation*}

This ledger rule is violated if any of the following violations occur:
\begin{itemize-multi}
  \item \hyperref[violation:MISSING-MULTISIG-SCRIPT]{MISSING-MULTISIG-SCRIPT}
\end{itemize-multi}

\subsubsection{MISSING-MULTISIG-SCRIPT violation}
\label{violation:MISSING-MULTISIG-SCRIPT}
A required script, corresponding to $h$ is missing.
Formal specification:
\begin{equation*}
\begin{split}
  \exists t \in txs, & \exists u \in output(t), addr(u) \in Addr^{script} \land \\
  & \nexists (h, s) \in script\_tx\_wits(t), script\_hash(addr(u)) = h
\end{split}
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule. 
  \item A membership proof must be provided that shows that the transaction $t$ is included in the ledger.
  \item A membership proof must be generated that proves that $u$ is in $outputs(t)$.
  \item A DA layer proof must be shown that certifies that there is no $(h, s)$ curresponding to \break
        $script\_hash(addr(u)) = h$ in $script\_tx\_wits(t)$.
\end{enumerate}

\subsection{Rule: Multisig scripts validated}
\label{rule:multisig-scripts-validated}

All multisig scripts validations pass.
Formal specification:
\begin{equation*}
\begin{split}
  \forall t \in txs, \forall (h, s) \in script\_tx\_wits(t), multisig\_validation\_succeeds(s, t)
\end{split}
\end{equation*}

% TODO: clarify validation logic
\todo

This ledger rule is violated if any of the following violations occur:
\begin{itemize-multi}
  \item \hyperref[violation:MULTISIG-INVALID]{MULTISIG-INVALID}
\end{itemize-multi}

\subsubsection{MULTISIG-INVALID violation}
\label{violation:MULTISIG-INVALID}
A multisig script $s$ validation fails.
Formal specification:
\begin{equation*}
\begin{split}
  \exists t \in txs, \exists (h, s) \in script\_tx\_wits(t), \lnot multisig\_validation\_succeeds(s, t)
\end{split}
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule. 
  \item A membership proof must be provided that shows that the transaction $t$ is included in the ledger.
  \item A DA layer proof must be shown that certifies that $(h, s)$ exists in $script\_tx\_wits(t)$.
  \item The $multisig\_validation\_succeeds(s, t)$ fails.
\end{enumerate}

\subsection{Rule: Value preservation}
\label{rule:value-preservation}
The total value must be preserved.
Formal specification:
\begin{equation*}
\begin{split}
    \forall t \in Ledger &, \\
    & mint(t) + \sum_{i \, \in \, spend\_inputs(t)} value(i) = fee(t) + \sum_{o \, \in \, outputs(t)} value(o)
\end{split}
\end{equation*}
        
This ledger rule is violated if any of the following violations occur:
\begin{itemize-multi}
  \item \hyperref[violation:VALUE-NOT-PRESERVED]{VALUE-NOT-PRESERVED}
\end{itemize-multi}

\subsubsection{VALUE-NOT-PRESERVED violation}
\label{violation:VALUE-NOT-PRESERVED}
Value is not preserved in transaction $t$.
Formal specification:
\begin{equation*}
  \begin{split}
      \exists t \in Ledger &, \\
      & mint(t) + \sum_{i \, \in \, spend\_inputs(t)} value(i) \neq fee(t) + \sum_{o \, \in \, outputs(t)} value(o)
  \end{split}
  \end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule. 
  \item A membership proof must be provided that shows that the transaction $t$ is included in the ledger.
  \item A DA layer proof must be shown that certifies the value of $sum(spend_inputs(t))$.
  \item A DA layer proof must be created that states the value of $sum(outputs(t))$.
  \item The sums in the calculation must show discrepancy.
\end{enumerate}

\subsection{Rule: No Ada minted}
\label{rule:no-ada-minted}
Ada must not be minted.
Formal specification:
\begin{equation*}
    \forall t \in Ledger, lovelaces(mint(t)) = 0
\end{equation*}

This ledger rule is violated if any of the following violations occur:
\begin{itemize-multi}
  \item \hyperref[violation:ADA-MINTED]{ADA-MINTED}
\end{itemize-multi}

\subsubsection{ADA-MINTED violation}
\label{violation:ADA-MINTED}
Ada is minted in transaction $t$.
Formal specification:
\begin{equation*}
  \exists t \in Ledger, lovelaces(mint(t)) \neq 0
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule.
  \item A membership proof must be provided that shows that the transaction $t$ is included in the ledger.
  \item $lovelaces(mint(t)) \neq 0$
\end{enumerate}

% \subsection{Rule: Maximum transaction size}
% \label{rule:maximum-transaction-size}

% \subsection{Rule: Maximum reference script size}
% \label{rule:maximum-reference-script-size}

% \subsection{Rule: Maximum value size}
% \label{rule:maximum-value-size}

\subsection{Rule: No negative value}
\label{rule:no-negative-value}
All values must be greater or equal to zero.
Formal specification:
\begin{equation*}
    \forall t \in Ledger, mint(t) \geq \mathbf{0} \, \land fee(t) \geq 0 \land \forall o \in outputs(t), \, value(o) \geq \mathbf{0}
\end{equation*}

This ledger rule is violated if any of the following violations occur:
\begin{itemize-multi}
  \item \hyperref[violation:NEGATIVE-MINT]{NEGATIVE-MINT}
  \item \hyperref[violation:NEGATIVE-FEE]{NEGATIVE-FEE}
  \item \hyperref[violation:NEGATIVE-OUTPUT-VALUE]{NEGATIVE-OUTPUT-VALUE}
\end{itemize-multi}

\subsubsection{NEGATIVE-MINT violation}
\label{violation:NEGATIVE-MINT}
Ada is minted in transaction $t$.
Formal specification:
\begin{equation*}
  \exists t \in Ledger, \exists m \in Policy, \exists tn \in TokenName, asset(mint(t), m, tn) < 0
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule.
  \item A membership proof must be provided that shows that the transaction $t$ is included in the ledger.
  \item A minting policy id $m$ and a token name $tn$ must be shown, such that $asset(mint(t), m, tn) < 0$
\end{enumerate}

\subsubsection{NEGATIVE-FEE violation}
\label{violation:NEGATIVE-FEE}
Ada is minted in transaction $t$.
Formal specification:
\begin{equation*}
  \exists t \in Ledger, fee(t) < 0
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule.
  \item A membership proof must be provided that shows that the transaction $t$ is included in the ledger.
  \item $fee(t)$ must be negative.
\end{enumerate}

\subsubsection{NEGATIVE-OUTPUT-VALUE violation}
\label{violation:NEGATIVE-OUTPUT-VALUE}
Ada is minted in transaction $t$.
Formal specification:
\begin{equation*}
  \exists t \in Ledger, \exists o \in outputs(t), \exists m \in Policy, \exists tn \in TokenName, asset(value(o), m, tn) < 0
\end{equation*}

Fraud proof construction:
\begin{enumerate}
  \item Let $t$ be the transaction alleged to violate the ledger rule.
  \item A membership proof must be provided that shows that the transaction $t$ is included in the ledger.
  \item A membership proof must be generated that states that $o \in outputs(t)$.
  \item A minting policy id $m$ and a token name $tn$ must be shown, such that $asset(value(o), m, tn) < 0$
\end{enumerate}

\subsection{Rule: Minimum UTxO value}
\label{rule:minimum-utxo-value}
% Same structure as in Cardano L1

\subsection{Rule: Network id of inputs}
\label{rule:network-id-of-inputs}

\subsection{Rule: Network id of reference inputs}
\label{rule:network-id-of-reference-inputs}

% Reference inputs are needed

\subsection{Rule: Network id of outputs}
\label{rule:network-id-of-outputs}

\subsection{Rule: Network id of withdrawals}
\label{rule:network-id-of-withdrawals}

\subsection{Rule: Network id of transaction}
\label{rule:network-id-of-transaction}

\subsection{Rule: All reference inputs must be valid}
\label{rule:all-reference-inputs-must-be-valid}

% TODO: maybe also include $inputs \cap reference\_inputs = \varnothing$

\subsection{Rule: Validator scripts are available}
\label{rule:validator-scripts-are-available}

% TODO: This is a placeholder, it will only be relevant once Midgard implements phase 2 validations (smart contracts).

\subsection{Rule: Validator scripts adhere to execution limits}
\label{rule:validator-scripts-adhere-to-execution-limits}

% TODO: This is a placeholder, it will only be relevant once Midgard implements phase 2 validations (smart contracts).

\subsection{Rule: Validator scripts accept transaction}
\label{rule:validator-scripts-accept-transaction}

% TODO: This is a placeholder, it will only be relevant once Midgard implements phase 2 validations (smart contracts).
% Maybe separate out staking and minting scripts in a separate rule

\subsection{Rule: Maximum number of collateral inputs}
\label{rule:maximum-number-of-collateral-inputs}

% TODO: This is a placeholder, it will only be relevant once Midgard implements phase 2 validations (smart contracts).

\end{document}
